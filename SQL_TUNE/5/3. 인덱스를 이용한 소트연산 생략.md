## 5.3 인덱스를 이용한 소트 연산 생략

### 5.3.1 Sort Order By 생략
- 인덱스를 조건절에 알맞게 구성할 경우 sort 연산이 생략이 가능하다. 
- 소트 연산이 생략 되므로 조건을 만족하는 전체 레코드를 읽지 않고 바로 결과집합이 출력 가능하다. = 부분범위 처리가 가능하다. 
  - 3-Tier 아키텍처는 서버 리소스를 수많은 클라이언트가 공유하는 구조 = 클라이언트가 특정 DB 커넥션을 독점 불가 
- 사진하나 추가 예정
### 5.3.2 TopN 쿼리
-	결과 집합 중 상위 N개 레코드만 선택하는 쿼리 

```
ex) SQL Server, Sybase – select TOP 10 거래일시, 체결수량 …
ex) IBM DB2 – FETCH FIRST 10 ROWS ONLY 
ex) Oracle – 인라인 뷰
```
```
select * from (
  select 거래일시, 체결건수, 체결수량, 거래대금
  from 종목거래
  where 종목코드 = 'KR123456'
  and 거래일시 >= '20180304'
  order by 거래일시
)
where rownum <= 10
```
- 인덱스[종목코드 + 거래일시]
  - 구성시 옵티마이저가 소트 연산 생략
- 사진두장 추가예정

-	COUNT(STOPKEY) : ROWNUM으로 지정한 건수만큼 레코드 결과를 얻으면 멈춘다. 
  - Top N Stopkey 알고리즘 
-	페이징 처리에서 많이 사용
```
rownum <= ( :page * 10 ) 
rownum 제거시 Stopkey가 작동하지 않는다. = 전체범위 처리 
```
#### 부분범위 처리가 가능한 SQL 조건
- 인덱스를 사용하도록 조건절 작성
- 조인은 NL 조인 위주로 되도록
- Order by 가 있어도 소트 연산이 생략되도록 인덱스 구성 

### 5.3.3 최소값/최대값 구하기
-	인덱스를 사용하여 전체 데이터를 읽지 않고 최소, 최대값을 찾는다.
```
실행계획 - INDEX (FULL SCAN (MIN/MAX)) OF ‘EMP_X1’ (INDEX) (Cost=1 Card=1… )
```
- 오라클 8i 부터 등장 / 8버전 이전에는 인덱스가 있어도 풀 스캔을 함 
-	조건절과 MIN/MAX 함수 인자 컬럼이 모두 인덱스 포함돼야 한다. 
-	인덱스 선두 컬럼이 = 조건이여야 한다. 
  - 조건을 만족하는 범위(Range)의 가장 오른쪽 값을 하나 읽는다. 
#### First Row Stopkey 알고리즘
- FIRST ROW 조건을 만족하는 레코드를 하나 찾으면 멈춤
-	Top N 쿼리를 사용해 최소, 최대값을 구할 수 있다. 
-	ROWNUM <= 1 조건을 이용해 Top 1 레코드를 찾는다. 
  - 모든 컬럼이 인덱스에 없어도 작동 
  - MIN/MAX 쿼리보다 성능이 좋음 
- 사진 하나 추가 예정 
  - 완성된 페이징 처리 SQL
  - rownum 조건절 생략시 Sort Order By가 나타나지 않지만 Stopkey도 안나타난다. 
  - Stopkey가 없으면 전체 범위를 처리한다. 
 
### 5.3.4 이력조회
- 변경이력을 관리하기 위해 상태변경이력 테이블을 만든다. 
- 상태변경이력 테이블에는 과거 변경이력과 현재 데이터도 저장한다. 
>	이력 데이터 조회시 ‘First Row Stopkey’ 또는 ‘Top N Stopkey’ 알고리즘이 작동하도록 
인덱스 설계 및 SQL 구현해야 한다. 

- 인덱스 컬럼 가공시 ‘First Row Stopkey’ 알고리즘이 작동하지 않는다. 
>ex) 이력이 많을 경우 서브 쿼리를 3번 사용해서 
‘First Row Stopkey’ 알고리즘을 작동하게 하는 것이 더 효율이 좋다. 
- 사진 한장 추가 예정
>ex) INDEX_DESC 힌트를 사용하고, rownum <= 1 조건절을 사용하는 방식
>ex) 11g/12c 신기능 활용
```
11g - ‘Predicate Pushing’ 쿼리 변환 기능이 작동하도록
12c – 파싱 오류 없이 ‘Top N Stopkey’ 알고리즘이 작동한다. 
``` 
- 사진하나 추가 예정
-	전체(=많은) 장비 이력 조회 
  - Stopkey 작동여부가 핵심이 아닌, 전체를 빠르게 처리하는 것이 목표
  - ex) 윈도우 함수 이용
  - ex) KEEP절 활용
  - FROM MAX(상태코드) KEEP (DENSE_RANK LAST ORDER BT 변경일자, 변경순번) 변경순번
-	선분이력 모델
  - #변경일자 -> #유효시작일자, #유효종료일자
  - 선분이력 모델 사용시 간단한 쿼리로 이력 조회 가능 

### 5.3.5 Sort Group By 생략
- region이 선두 컬럼인 인덱스 사용시 Sort Group By 연산을 생략 가능
- 사진 두장 추가 예정